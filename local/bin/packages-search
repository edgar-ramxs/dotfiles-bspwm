#!/usr/bin/env bash

# üé® Colored message function
function message() {
    local RESET="\033[0m\e[0m"
    local styles=(
        ["-title"]="\033[0;37m\033[1m [$]"
        ["-subtitle"]="\033[0;35m\033[1m [*]"
        ["-approval"]="\033[38;5;51m\033[1m [?]"
        ["-cancel"]="\033[0;34m\033[1m [!]"
        ["-success"]="\033[0;32m\033[1m [+]"
        ["-warning"]="\033[0;33m\033[1m [&]"
        ["-error"]="\033[0;31m\033[1m [-]"
    )
    local style="${styles[$1]}"
    shift
    [[ "$style" =~ \[\$\]|\[\*\]|\[\?\]|\[\!\] ]] && echo -e "\n${style} $*${RESET}" || echo -e "\t${style} $*${RESET}"
}

# üìñ Usage/help
function usage() {
    message -title "Usage:"
    message -warning "Flags         Example"
    message -success "-f [file]     $0 -f packages.txt"
    message -success "[no-flag]     $0 package1 package2 ..."
    echo ""
    exit 1
}

# üö´ Ctrl+C handler
trap 'message -cancel "Exiting..."; exit 1' INT

# ‚úÖ Execution result checker
function check_execution() {
    local code="$1" error="$2" success="$3"
    if [[ "$code" != 0 && "$code" != 130 ]]; then
        message -error "$error"
    else
        message -success "$success"
    fi
    sleep 0.5
}

# üì¶ Detect distro
DISTRO=$(grep -i '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"' | tr '[:upper:]' '[:lower:]')

# üì• Input handling
FILE=""
PACKAGES=()

while getopts ":f:" opt; do
    case "$opt" in
        f)
            FILE="$OPTARG"
            [[ -z "$FILE" ]] && message -error "La opci√≥n -f requiere un valor." && exit 1
            ;;
        \?)
            usage ;;
    esac
done
shift $((OPTIND - 1))

if [[ -z "$FILE" && $# -eq 0 ]]; then
    message -error "Debes especificar paquetes como argumentos o con -f archivo."
    usage
fi

# üóÇÔ∏è Leer archivo o argumentos
if [[ -n "$FILE" ]]; then
    [[ ! -f "$FILE" ]] && message -error "El archivo no existe: $FILE" && exit 1
    readarray -t PACKAGES < <(grep -Ev '^\s*#|^\s*$' "$FILE")
else
    PACKAGES=("$@")
fi

# üß† Detectar comandos seg√∫n distro
case "$DISTRO" in
    debian|ubuntu|kali|mint|parrot)
        CHECK_CMD="dpkg -l"
        AVAILABLE_CMD="apt-cache show"
        ;;
    arch|manjaro)
        CHECK_CMD="pacman -Qq"
        AVAILABLE_CMD="pacman -Si"
        ;;
    fedora|centos|rhel)
        CHECK_CMD="rpm -q"
        AVAILABLE_CMD="dnf info"
        ;;
    *)
        message -cancel "Distribuci√≥n no soportada: $DISTRO"
        exit 1
        ;;
esac

# üîç Verificar cada paquete
for package in "${PACKAGES[@]}"; do
    if eval "$CHECK_CMD" | grep -qw "$package"; then
        message -success "[INSTALADO] $package"
    elif $AVAILABLE_CMD "$package" &>/dev/null; then
        message -warning "[DISPONIBLE] $package"
    else
        message -error "[NO DISPONIBLE] $package"
    fi
done

#!/usr/bin/env bash

# üé® Mensajes coloreados
function message() {
    local RESET="\033[0m\e[0m"
    declare -A styles=(
        ["-title"]="\033[0;37m\033[1m [$]"
        ["-subtitle"]="\033[0;35m\033[1m [*]"
        ["-approval"]="\033[38;5;51m\033[1m [?]"
        ["-cancel"]="\033[0;34m\033[1m [!]"
        ["-success"]="\033[0;32m\033[1m [+]"
        ["-warning"]="\033[0;33m\033[1m [&]"
        ["-error"]="\033[0;31m\033[1m [-]"
    )
    local tag="$1"; shift
    local style="${styles[$tag]}"
    echo -e "${style} $*${RESET}"
}

# üìñ Uso
function usage() {
    message -title "Usage: $0 [options]"
    echo ""
    for key in "${!VARIABLE_FLAGS[@]}"; do
        printf "  -%s %-12s Set %s\n" "$key" "<value>" "${VARIABLE_FLAGS[$key]}"
    done
    echo ""
    exit 1
}

# ‚õî Ctrl+C
trap 'message -cancel "Exiting..."; exit 1' INT

# üîÅ Resultado de ejecuci√≥n
function check_execution() {
    local code="$1" error="$2" success="$3"
    if [[ "$code" != 0 && "$code" != 130 ]]; then
        message -error "$error"
    else
        message -success "$success"
    fi
    sleep 0.5
}

# üß† Agrega o actualiza variable en archivo
function add_or_update_variable() {
    local VAR_NAME="$1"
    local VAR_VALUE="$2"
    if grep -q "^${VAR_NAME}=" "$ENV_FILE"; then
        sudo sed -i "s|^${VAR_NAME}=.*|${VAR_NAME}=\"${VAR_VALUE}\"|" "$ENV_FILE"
        message -success "Actualizado: $VAR_NAME=\"$VAR_VALUE\""
    else
        echo "${VAR_NAME}=\"${VAR_VALUE}\"" | sudo tee -a "$ENV_FILE" > /dev/null
        message -success "A√±adido: $VAR_NAME=\"$VAR_VALUE\""
    fi
}

# üìÅ Archivo de entorno
ENV_FILE="/etc/environment"

# üîß Definici√≥n de variables por bandera
declare -A VARIABLE_FLAGS=(
    [p]="PATH"
    [e]="EDITOR"
    [b]="BROWSER"
    [w]="WEATHER_KEY"
    # ‚ûï Puedes agregar m√°s variables aqu√≠, por ejemplo:
    # [s]="SHELL"
    # [u]="USERNAME"
)

# üì¶ Validaci√≥n de comandos necesarios
for cmd in grep sudo; do
    if ! command -v "$cmd" &> /dev/null; then
        message -error "Comando no encontrado: $cmd"
        exit 1
    fi
done

# üß™ Verifica si se us√≥ alguna opci√≥n v√°lida
USED_OPTION=false

# üõ†Ô∏è Procesar argumentos
declare -A USER_VALUES

while getopts ":${!VARIABLE_FLAGS[*]}" opt; do
    if [[ -n "${VARIABLE_FLAGS[$opt]}" ]]; then
        if [[ -z "$OPTARG" || "$OPTARG" == -* ]]; then
            message -error "La opci√≥n -$opt requiere un valor v√°lido."
            exit 1
        fi
        USER_VALUES["${VARIABLE_FLAGS[$opt]}"]="$OPTARG"
        USED_OPTION=true
    else
        message -error "Opci√≥n inv√°lida: -$OPTARG"
        usage
    fi
done

# üõ°Ô∏è Pedir sudo una vez
[[ "$USED_OPTION" = true ]] && sudo -v

# üíæ Guardar las variables al archivo
for var in "${!USER_VALUES[@]}"; do
    add_or_update_variable "$var" "${USER_VALUES[$var]}"
done

# ‚ùì Si no se us√≥ ninguna opci√≥n, mostrar ayuda
if [[ "$USED_OPTION" = false ]]; then
    usage
fi


# QT_QPA_PLATFORMTHEME=qt6ct
# EDITOR=nano
# BROWSER=firefox
# TERMINAL=alacritty
#PATH="/usr/share/siberizm/scripts"
#WLR_NO_HARDWARE_CURSORS=1